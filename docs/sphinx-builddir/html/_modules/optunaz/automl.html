<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>optunaz.automl &mdash; QSARtuna 3.1.3 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/autodoc_pydantic.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            QSARtuna
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Intro and Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/preprocess_data.html">Jupyter Notebook: Preprocessing Data for QSARtuna</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/QSARtuna_Tutorial.html">QSARtuna CLI Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/QSARtuna_Tutorial.html#AutoML-(Automated-model-retraining)">AutoML (Automated model retraining)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms.html">List of available ML algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../descriptors.html">List of available molecular descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../splitters.html">List of available evaluation splits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transform.html">List of available data transform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deduplicator.html">List of available deduplicators</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QSARtuna</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">optunaz.automl</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for optunaz.automl</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">from</span> <span class="nn">pid.decorator</span> <span class="kn">import</span> <span class="n">pidfile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">effective_n_jobs</span>
<span class="kn">from</span> <span class="nn">optunaz.utils.retraining</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">from</span> <span class="nn">optunaz.config</span> <span class="kn">import</span> <span class="n">LOG_CONFIG</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ModelAutoML"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelAutoML">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">ModelAutoML</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the data ready for the model training with ModelDispatcher.</span>
<span class="sd">    The ModelAutoML will also store activity for new tasks pending enough data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">smiles_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">activity_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">task_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">timestr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrain_timepoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_name</span> <span class="o">=</span> <span class="n">user_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span> <span class="o">=</span> <span class="n">smiles_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activity_col</span> <span class="o">=</span> <span class="n">activity_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_col</span> <span class="o">=</span> <span class="n">task_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestr</span> <span class="o">=</span> <span class="n">timestr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="n">effective_n_jobs</span><span class="p">(</span><span class="n">n_cores</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_col</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> does not exist, creating it&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json exists&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json not set&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">processed_timepoints</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_timepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_timepoints</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="ModelAutoML.getAllRetrainingData"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelAutoML.getAllRetrainingData">[docs]</a>    <span class="k">def</span> <span class="nf">getAllRetrainingData</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dict of the wilcard data with converted datetime as the keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">glob_fs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">glob_f</span> <span class="ow">in</span> <span class="n">glob_fs</span><span class="p">:</span>
                <span class="n">potential_dates</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">glob_f</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">potential_date</span> <span class="ow">in</span> <span class="n">potential_dates</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">potential_date</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">fs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">glob_f</span>
                        <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">if</span> <span class="n">glob_f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">NoRetrainingDataConvention</span><span class="p">(</span><span class="n">potential_dates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fs</span><span class="p">[</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_data</span><span class="p">))</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span>
        <span class="k">return</span> <span class="n">fs</span></div>

<div class="viewcode-block" id="ModelAutoML.getRetrainingData"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelAutoML.getRetrainingData">[docs]</a>    <span class="k">def</span> <span class="nf">getRetrainingData</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data for the latest unprocessed date bucket or raise NoNewRetrainingData if none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getAllRetrainingData</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ybin</span><span class="p">,</span> <span class="n">thisf</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">process_ybin</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">ybin</span><span class="p">,</span> <span class="s2">&quot;%y_%m_</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process_ybin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_timepoints</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process_ybin</span><span class="si">}</span><span class="s2"> is in processed_timepoints.json&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">task_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                    <span class="n">thisf</span><span class="p">,</span>
                    <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin&quot;</span><span class="p">,</span>
                    <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                    <span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thisf</span><span class="si">}</span><span class="s2"> has PermissionError&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">avail_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">thisf</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
                <span class="n">miss_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avail_cols</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">RetrainingHeadersIssue</span><span class="p">(</span><span class="n">process_ybin</span><span class="p">,</span> <span class="n">miss_headers</span><span class="p">)</span>
            <span class="n">task_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span>
                <span class="n">task_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activity_col</span><span class="p">]</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process_ybin</span><span class="si">}</span><span class="s2"> has no valid datapoints&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">task_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">process_ybin</span>
        <span class="k">raise</span> <span class="n">NoNewRetrainingData</span></div>

<div class="viewcode-block" id="ModelAutoML.setRetrainingData"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelAutoML.setRetrainingData">[docs]</a>    <span class="k">def</span> <span class="nf">setRetrainingData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the newest data bucket and timepoint for latest available data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_data</span><span class="p">,</span> <span class="n">retrain_timepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRetrainingData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_data</span> <span class="o">=</span> <span class="n">new_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrain_timepoint</span> <span class="o">=</span> <span class="n">retrain_timepoint</span></div>

<div class="viewcode-block" id="ModelAutoML.initProcessedTimepoints"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelAutoML.initProcessedTimepoints">[docs]</a>    <span class="k">def</span> <span class="nf">initProcessedTimepoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the JSON containing timepoints for a first run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newf</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">([],</span> <span class="n">newf</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Init first processed timepoint to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ModelAutoML.setProcessedTimepoints"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelAutoML.setProcessedTimepoints">[docs]</a>    <span class="k">def</span> <span class="nf">setProcessedTimepoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the processed timepoints and the currently processing timepoint to JSON</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">problem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_processed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processed_timepoints</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">problem</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Appended problem timepoint </span><span class="si">{</span><span class="n">problem</span><span class="si">}</span><span class="s2"> to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_processed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processed_timepoints</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Appended processed timepoint </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json&quot;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/processed_timepoints.json&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newf</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">new_processed</span><span class="p">,</span> <span class="n">newf</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ModelDispatcher"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">ModelDispatcher</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use ModelAutoML config as a basis to prepare QSARtuna jobs, dispatching to SLURM.</span>
<span class="sd">    ModelDispatcher always needs a quorum to prepare the model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">quorum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cfg</span><span class="p">:</span> <span class="n">ModelAutoML</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">last_timepoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">initial_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">retrain_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slurm_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slurm_req_cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">slurm_req_partition</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slurm_req_mem</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slurm_al_pool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slurm_al_smiles</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slurm_job_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slurm_partition</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_previous_models</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_conf</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_preds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">al_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_model_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quorum</span> <span class="o">=</span> <span class="n">quorum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_retry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_log</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_template</span> <span class="o">=</span> <span class="n">slurm_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_job_prefix</span> <span class="o">=</span> <span class="n">slurm_job_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_partition</span> <span class="o">=</span> <span class="n">slurm_partition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_cores</span> <span class="o">=</span> <span class="n">slurm_req_cores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_partition</span> <span class="o">=</span> <span class="n">slurm_req_partition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_mem</span> <span class="o">=</span> <span class="n">slurm_req_mem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_al_pool</span> <span class="o">=</span> <span class="n">slurm_al_pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_al_smiles</span> <span class="o">=</span> <span class="n">slurm_al_smiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_timepoint</span> <span class="o">=</span> <span class="n">last_timepoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_template</span> <span class="o">=</span> <span class="n">initial_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrain_template</span> <span class="o">=</span> <span class="n">retrain_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_previous_models</span> <span class="o">=</span> <span class="n">save_previous_models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_conf</span> <span class="o">=</span> <span class="n">log_conf</span>
        <span class="k">if</span> <span class="n">log_conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">log_conf</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pretrained_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a pretrained model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_model</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_model_name</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newf</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">newf</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_model</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoPreviousModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_model_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pretrained_model</span>

<div class="viewcode-block" id="ModelDispatcher.checkIfRetrainingProcessed"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.checkIfRetrainingProcessed">[docs]</a>    <span class="k">def</span> <span class="nf">checkIfRetrainingProcessed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taskcode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if this timepoint has already been predicted (and therefore processed).</span>
<span class="sd">        Timepoints to be skipped with data but no model quorum will also be in .skipped dirs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">al_file</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">: Retraining [</span><span class="si">{</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">] is processed&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">RetrainingIsAlreadyProcessed</span><span class="p">(</span><span class="n">taskcode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkSkipped</span><span class="p">():</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">: Retraining [</span><span class="si">{</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">] is set to skipped&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">TimepointSkipped</span><span class="p">(</span><span class="n">taskcode</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.checkisLocked"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.checkisLocked">[docs]</a>    <span class="k">def</span> <span class="nf">checkisLocked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taskcode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if this timepoint is locked for a given taskcode.</span>
<span class="sd">        Locks occur if QSARtuna is unable to run multiple retrain script instances run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">: Lockfile [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span><span class="si">}</span><span class="s2">] locks the taskcode [</span><span class="si">{</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">RetrainingIsLocked</span><span class="p">(</span><span class="n">taskcode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">: Lockfile [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span><span class="si">}</span><span class="s2">] not set; no lock for taskcode [</span><span class="si">{</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.checkRunningSlurmJobs"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.checkRunningSlurmJobs">[docs]</a>    <span class="k">def</span> <span class="nf">checkRunningSlurmJobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dry run of /usr/bin/squeue&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/usr/bin/squeue --Format=name&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
        <span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">running_jobs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_job_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_job_prefix</span><span class="p">)]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_job_prefix</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">running_jobs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active/queued SLURM jobs are: </span><span class="si">{</span><span class="n">running_jobs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Active/queued SLURM jobs&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">running_jobs</span></div>

<div class="viewcode-block" id="ModelDispatcher.calcSlurmMem"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.calcSlurmMem">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calcSlurmMem</span><span class="p">(</span><span class="n">len_file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamic resource allocation for memory from query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">60000</span><span class="p">,</span> <span class="mi">200000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
        <span class="n">req_mem</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">([</span><span class="n">len_file</span><span class="p">],</span> <span class="n">bins</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="k">return</span> <span class="n">req_mem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ModelDispatcher.setDispatcherVariables"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.setDispatcherVariables">[docs]</a>    <span class="k">def</span> <span class="nf">setDispatcherVariables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taskcode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets environment variables on a per taskcode level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">taskcode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">taskcode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/data/</span><span class="si">{</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">.sh&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_log</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">.out&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_retry</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span><span class="si">}</span><span class="s2">/.retry&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_model_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">.meta&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_model</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span><span class="si">}</span><span class="s2">/latest.pkl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">al_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">.al&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span><span class="si">}</span><span class="s2">/.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span><span class="si">}</span><span class="s2">/.skip&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_file</span> <span class="o">=</span> <span class="s2">&quot;TEMPORALFILE&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_preds</span> <span class="o">=</span> <span class="s2">&quot;TEMPORALPREDS&quot;</span></div>

<div class="viewcode-block" id="ModelDispatcher.setJobLocked"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.setJobLocked">[docs]</a>    <span class="k">def</span> <span class="nf">setJobLocked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates lock file to ensure future runs do not overwrite pending jobs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">: Lockfile [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span><span class="si">}</span><span class="s2">] is already locked&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lock_file for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span><span class="si">}</span><span class="s2"> was set&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.processTrain"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.processTrain">[docs]</a>    <span class="k">def</span> <span class="nf">processTrain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_taskcode_df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Opens existing training if possible, formats data and attributes set for prev data</span>
<span class="sd">        If no retrain, create directory, returns new smiles &amp; y for train</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">this_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_file</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="n">this_df</span><span class="p">[</span><span class="s2">&quot;automl_predefined_split&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">_taskcode_df</span><span class="p">[</span><span class="s2">&quot;automl_predefined_split&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">this_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">this_df</span><span class="p">,</span> <span class="n">_taskcode_df</span><span class="p">))</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
                    <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">activity_col</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span>
                <span class="p">)</span>
                <span class="n">len_new</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;automl_predefined_split == 1&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">len_new</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">NoDifferingRetrainingData</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">len_new</span><span class="si">}</span><span class="s2"> new data points found&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">this_df</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">_taskcode_df</span><span class="p">[</span><span class="s2">&quot;automl_predefined_split&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_base</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o777</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_taskcode_df</span></div>

<div class="viewcode-block" id="ModelDispatcher.processQuorum"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.processQuorum">[docs]</a>    <span class="k">def</span> <span class="nf">processQuorum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_input_df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates quorum &amp; formats retraining data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_input_df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">activity_col</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">)</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">activity_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">means</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">activity_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="o">.</span><span class="n">abs</span><span class="p">()</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">quorum</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quorum</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">quorum</span></div>

<div class="viewcode-block" id="ModelDispatcher.isTrained"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.isTrained">[docs]</a>    <span class="k">def</span> <span class="nf">isTrained</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="si">}</span><span class="s2"> exists&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="si">}</span><span class="s2"> not present&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ModelDispatcher.checkSaveTemporalModel"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.checkSaveTemporalModel">[docs]</a>    <span class="k">def</span> <span class="nf">checkSaveTemporalModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_previous_models</span><span class="p">:</span>
            <span class="n">save_n</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrained_model</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
            <span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_model_name</span><span class="p">,</span> <span class="n">save_n</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved pretrained </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2"> model to </span><span class="si">{</span><span class="n">save_n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.doTemporalPredictions"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.doTemporalPredictions">[docs]</a>    <span class="k">def</span> <span class="nf">doTemporalPredictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start/check temporal (pseudo-prospective) predictions with an old QSARtuna model vs. newest data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_model</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">SamePreviousModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrained_model</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">__&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_preds</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_file</span><span class="si">}</span><span class="s2">.preds&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_preds</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TemporalPredsPredicted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setJobLocked</span><span class="p">()</span>
        <span class="n">new_data</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">activity_col</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">smiles_col</span>
        <span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeSlurm</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submitJob</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not submit temporal SLURM job for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrained_model</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> model used to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;predict </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2"> datapoints&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkSaveTemporalModel</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="ModelDispatcher.writeSlurm"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.writeSlurm">[docs]</a>    <span class="k">def</span> <span class="nf">writeSlurm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a slurm job for a QSARtuna run for a given taskcode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_template</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">openFile</span><span class="p">:</span>
                <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">openFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_job_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;TASK_FILE&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;METAFILE&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;AL_FILE&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">al_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;EMAIL&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LOCK&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lock_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;RETRY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_retry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LATEST&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;MEM&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_mem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;CORES&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_cores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;PARTITION&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_partition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;AL_POOL&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_al_pool</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;AL_SMILES&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_al_smiles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">smiles_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;TEMPORALFILE&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;TEMPORALPREDS&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_preds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrote slurm to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="ModelDispatcher.writeJson"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.writeJson">[docs]</a>    <span class="k">def</span> <span class="nf">writeJson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a QSARtuna json for a given taskcode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retrain_template</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_template</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">openFile</span><span class="p">:</span>
                <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">openFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;DATASET_FILE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_file</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;LATEST&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_model</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SMILES&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;ACTIVITY&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">activity_col</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrote json to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">json_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="ModelDispatcher.writeDataset"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.writeDataset">[docs]</a>    <span class="k">def</span> <span class="nf">writeDataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the training datapoints to file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrote dataset to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.setSkippedTimepoint"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.setSkippedTimepoint">[docs]</a>    <span class="k">def</span> <span class="nf">setSkippedTimepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Annotate the timepoint as not eligable for a taskcode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">skipped_timepoints</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">skipped_timepoints</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skip file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span><span class="si">}</span><span class="s2"> will be created&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">newf</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">skipped_timepoints</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="p">],</span> <span class="n">newf</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2"> added to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.checkSkipped"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.checkSkipped">[docs]</a>    <span class="k">def</span> <span class="nf">checkSkipped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">skipped_timepoints</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span><span class="si">}</span><span class="s2"> not present&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span><span class="si">}</span><span class="s2"> error&quot;</span><span class="p">)</span>
        <span class="n">is_skipped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span> <span class="ow">in</span> <span class="n">skipped_timepoints</span>
        <span class="k">if</span> <span class="n">is_skipped</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Timepoint </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2"> is in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">is_skipped</span></div>

<div class="viewcode-block" id="ModelDispatcher.submitJob"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.submitJob">[docs]</a>    <span class="k">def</span> <span class="nf">submitJob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">sbatch</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;/usr/bin/sbatch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SLURM output: </span><span class="si">{</span><span class="n">sbatch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sbatch</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> submitted&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sbatch</span><span class="o">.</span><span class="n">returncode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dry run of /usr/bin/sbatch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="ModelDispatcher.checkSlurmStatusAndNextProcedure"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.checkSlurmStatusAndNextProcedure">[docs]</a>    <span class="k">def</span> <span class="nf">checkSlurmStatusAndNextProcedure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check a SLURM job completed with no cancellations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">slurm_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_log</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;DUE TO TIME LIMIT&quot;</span> <span class="ow">in</span> <span class="n">slurm_log</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> time limit was reached&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SlurmTimeLimitExceeded</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">err</span> <span class="ow">in</span> <span class="n">slurm_log</span>
                    <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;DUE TO MEMORY&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Bus error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Unable to allocate&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;oom_kill&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;OOM Killed&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span>
            <span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> memory was reached&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SlurmMemoryExceeded</span>
            <span class="k">elif</span> <span class="s2">&quot;func_code.py&quot;</span> <span class="ow">in</span> <span class="n">slurm_log</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> had func_code.py error&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;numpy.ComplexWarning&quot;</span> <span class="ow">in</span> <span class="n">slurm_log</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> had numpy.ComplexWarning&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;ValueError: Exiting since no trials returned values&quot;</span> <span class="ow">in</span> <span class="n">slurm_log</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> had no valid trials&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SlurmJobSkip</span>
            <span class="k">elif</span> <span class="s2">&quot;Adjust any of the aforementioned parameters&quot;</span> <span class="ow">in</span> <span class="n">slurm_log</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> had splitting error&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SlurmJobSkip</span>
            <span class="k">elif</span> <span class="s2">&quot;qptuna.predict.UncertaintyError&quot;</span> <span class="ow">in</span> <span class="n">slurm_log</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> does not support uncertainty estimation&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SlurmJobSkip</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SlurmNoLog</span></div>

<div class="viewcode-block" id="ModelDispatcher.increaseJobTime"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.increaseJobTime">[docs]</a>    <span class="k">def</span> <span class="nf">increaseJobTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minutes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Increase SLURM model time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_sh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l_idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job_sh</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;--time&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                    <span class="n">old_time</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">job_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%H:%M&quot;</span><span class="p">)</span>
                    <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">job_time</span> <span class="o">+</span> <span class="n">mins</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%H:%M&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                        <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> increased time by [</span><span class="si">{</span><span class="n">minutes</span><span class="si">}</span><span class="s2">] from [</span><span class="si">{</span><span class="n">old_time</span><span class="si">}</span><span class="s2">] to [</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">job_sh</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to increase [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2">] job time&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">SlurmParseError</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">job_sh</span><span class="p">:</span>
                <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.increaseJobMem"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.increaseJobMem">[docs]</a>    <span class="k">def</span> <span class="nf">increaseJobMem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">max_mem</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Increase SLURM model memory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_sh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l_idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job_sh</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;--mem&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(\d+)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">old_mem</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">new_mem</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">mem</span>
                    <span class="k">if</span> <span class="n">new_mem</span> <span class="o">&gt;=</span> <span class="n">max_mem</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2">] new mem [</span><span class="si">{</span><span class="n">new_mem</span><span class="si">}</span><span class="s2">]G  &gt;= max: [</span><span class="si">{</span><span class="n">max_mem</span><span class="si">}</span><span class="s2">]G&quot;</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="n">SlurmParseError</span>
                    <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_mem</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> increasing mem by [</span><span class="si">{</span><span class="n">mem</span><span class="si">}</span><span class="s2">G] from [</span><span class="si">{</span><span class="n">old_mem</span><span class="si">}</span><span class="s2">G] to [</span><span class="si">{</span><span class="n">new_mem</span><span class="si">}</span><span class="s2">G]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">job_sh</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unable to increase [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2">] memory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">SlurmParseError</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">job_sh</span><span class="p">:</span>
                <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.increaseJobCpu"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.increaseJobCpu">[docs]</a>    <span class="k">def</span> <span class="nf">increaseJobCpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">max_cpu</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Increase SLURM model cpu</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_sh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l_idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job_sh</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;#SBATCH -c &quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(\d+)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">old_cpu</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">new_cpu</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">cpu</span>
                    <span class="k">if</span> <span class="n">new_cpu</span> <span class="o">&gt;=</span> <span class="n">max_cpu</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2">] new cpu [</span><span class="si">{</span><span class="n">new_cpu</span><span class="si">}</span><span class="s2">]  &gt;= max: [</span><span class="si">{</span><span class="n">max_cpu</span><span class="si">}</span><span class="s2">]&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span>
                    <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_cpu</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> increasing cpu by [</span><span class="si">{</span><span class="n">cpu</span><span class="si">}</span><span class="s2">] from [</span><span class="si">{</span><span class="n">old_cpu</span><span class="si">}</span><span class="s2">] to [</span><span class="si">{</span><span class="n">new_cpu</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">job_sh</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to increase [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2">] cpu: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">SlurmParseError</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">job_sh</span><span class="p">:</span>
                <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.addSlurmRetry"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.addSlurmRetry">[docs]</a>    <span class="k">def</span> <span class="nf">addSlurmRetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_retry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_retry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}])</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_retry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.getSlurmRetry"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.getSlurmRetry">[docs]</a>    <span class="k">def</span> <span class="nf">getSlurmRetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_retry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="ModelDispatcher.resubmitAnyFailedJobs"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.resubmitAnyFailedJobs">[docs]</a>    <span class="k">def</span> <span class="nf">resubmitAnyFailedJobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">locked_jobs</span><span class="p">,</span>
        <span class="n">minutes</span><span class="o">=</span><span class="mi">720</span><span class="p">,</span>
        <span class="n">mem</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">cpu</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">max_mem</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">max_cpu</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resubmit failed jobs, according to reason for failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">running_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkRunningSlurmJobs</span><span class="p">()</span>
        <span class="n">resubmitted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">failed_submission</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">locked_jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">running_jobs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setDispatcherVariables</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="n">retrys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSlurmRetry</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">retrys</span> <span class="o">&gt;</span> <span class="n">max_retries</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> had too many retries </span><span class="si">{</span><span class="n">retrys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setSkippedTimepoint</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">checkSlurmStatusAndNextProcedure</span><span class="p">()</span>
                    <span class="c1"># Problematic jobs that will always fail are skipped</span>
                    <span class="k">except</span> <span class="n">SlurmJobSkip</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">setSkippedTimepoint</span><span class="p">()</span>
                        <span class="k">continue</span>
                    <span class="c1"># Time limited jobs are extended (inc. memory since swap may slow job)</span>
                    <span class="k">except</span> <span class="n">SlurmTimeLimitExceeded</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">increaseJobTime</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">increaseJobMem</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">max_mem</span><span class="o">=</span><span class="n">max_mem</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">increaseJobCpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">max_cpu</span><span class="o">=</span><span class="n">max_cpu</span><span class="p">)</span>
                    <span class="c1"># Memory limited jobs are increased</span>
                    <span class="k">except</span> <span class="n">SlurmMemoryExceeded</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">increaseJobTime</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">increaseJobMem</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">max_mem</span><span class="o">=</span><span class="n">max_mem</span><span class="p">)</span>
                    <span class="c1"># Submit jobs that failed submission (maybe a sbatch glitch?)</span>
                    <span class="k">except</span> <span class="n">SlurmNoLog</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> never ran, so will be resubmit&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># If no detectable reason, then a requeue is still issued</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> had log but no detected abort/failure reason&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">increaseJobTime</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">increaseJobMem</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">max_mem</span><span class="o">=</span><span class="n">max_mem</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">increaseJobCpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">max_cpu</span><span class="o">=</span><span class="n">max_cpu</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">addSlurmRetry</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submitJob</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">resubmitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SlurmParseError</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> resubmit (</span><span class="si">{</span><span class="n">retrys</span><span class="si">}</span><span class="s2"> retrys)&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">SlurmParseError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">addSlurmRetry</span><span class="p">()</span>
                    <span class="n">failed_submission</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_name</span><span class="si">}</span><span class="s2"> failed resubmission (</span><span class="si">{</span><span class="n">retrys</span><span class="si">}</span><span class="s2"> retrys)&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> still running/queued&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resubmitted</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Some jobs were resubmitted: </span><span class="si">{</span><span class="n">resubmitted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_submission</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Some jobs failed resubmission: </span><span class="si">{</span><span class="n">failed_submission</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelDispatcher.processRetraining"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.ModelDispatcher.processRetraining">[docs]</a>    <span class="k">def</span> <span class="nf">processRetraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taskcode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enumerates through new data, creating the latest files and models</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">new_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">task_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">taskcode</span>
        <span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="c1"># set variable names each iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDispatcherVariables</span><span class="p">(</span><span class="n">taskcode</span><span class="p">)</span>
        <span class="c1"># do basic checks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkIfRetrainingProcessed</span><span class="p">(</span><span class="n">taskcode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checkisLocked</span><span class="p">(</span><span class="n">taskcode</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">RetrainingIsAlreadyProcessed</span><span class="p">,</span> <span class="n">TimepointSkipped</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="n">RetrainingIsLocked</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Locked&quot;</span><span class="p">:</span> <span class="n">taskcode</span><span class="p">}</span>

        <span class="c1"># add preexisiting bioactivites if possible, and process training</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processTrain</span><span class="p">(</span><span class="n">out_df</span><span class="p">)</span>
        <span class="c1"># skip taskcode if latest dataset adds no new data (could be duplicated csv)</span>
        <span class="k">except</span> <span class="n">NoDifferingRetrainingData</span><span class="p">:</span>
            <span class="c1"># handle here that there appears to be no differing data for first timepoint</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timepoint</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: Fist timepoint&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timepoint</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isTrained</span><span class="p">():</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: Retraining trained&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: No new data (or all duplicates)&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setSkippedTimepoint</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_timepoint</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: Something went wrong: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_timepoint</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processQuorum</span><span class="p">(</span><span class="n">out_df</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_mem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcSlurmMem</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_df</span><span class="p">))</span>  <span class="c1"># query sets mem</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: Dynamic resource allocation mem: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_mem</span><span class="si">}</span><span class="s2">G&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: Manual resource allocation mem: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_req_mem</span><span class="si">}</span><span class="s2">G&quot;</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># generate (and write) predictions of old model on new data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">doTemporalPredictions</span><span class="p">(</span><span class="n">out_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;automl_predefined_split == 1&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Working&quot;</span><span class="p">:</span> <span class="n">taskcode</span><span class="p">}</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">NoPreviousModel</span><span class="p">,</span> <span class="n">TemporalPredsPredicted</span><span class="p">,</span> <span class="n">SamePreviousModel</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">: No temporal predictions since [</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="p">)</span>
            <span class="c1"># write files for dispatch, lock &amp; dispatch to slurm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeDataset</span><span class="p">(</span><span class="n">out_df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeSlurm</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeJson</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setJobLocked</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submitJob</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: Could not submit SLURM job for </span><span class="si">{</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Working&quot;</span><span class="p">:</span> <span class="n">taskcode</span><span class="p">}</span>
        <span class="c1"># not quorum so write pred lock</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">taskcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">: Not quorum&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeDataset</span><span class="p">(</span><span class="n">out_df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setSkippedTimepoint</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{}</span></div></div>


<div class="viewcode-block" id="process_retraining_task"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.process_retraining_task">[docs]</a><span class="k">def</span> <span class="nf">process_retraining_task</span><span class="p">(</span><span class="n">taskcode</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">):</span>
    <span class="n">_dispatcher</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_dispatcher</span><span class="o">.</span><span class="n">processRetraining</span><span class="p">(</span><span class="n">taskcode</span><span class="p">)</span></div>


<div class="viewcode-block" id="dispatcher_process"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.dispatcher_process">[docs]</a><span class="k">def</span> <span class="nf">dispatcher_process</span><span class="p">(</span><span class="n">global_cfg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">):</span>
    <span class="n">work</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">global_cfg</span><span class="o">.</span><span class="n">new_data</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">input_task_csv_column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">global_cfg</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">global_cfg</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;threading&quot;</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">process_retraining_task</span><span class="p">)(</span><span class="n">w</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">work</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Process tasks sequentially</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">processRetraining</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">work</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="meta"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.meta">[docs]</a><span class="nd">@pidfile</span><span class="p">(</span><span class="n">piddir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">meta</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tracks temporal performance of QSARtuna models by writing the metadata to JSON files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;AutoML output performance of temporal models&quot;</span>
    <span class="p">)</span>

    <span class="c1"># fmt: off</span>
    <span class="n">requiredNamed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;required named arguments&#39;</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--pkl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the output QSARtuna PKL file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--meta&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the output metadata file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># fmt: off</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">leftovers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pkl</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">prev_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">prev_model</span><span class="o">.</span><span class="n">metadata</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>


<div class="viewcode-block" id="validate_args"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.validate_args">[docs]</a><span class="k">def</span> <span class="nf">validate_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">slurm_al_pool</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;AL pool </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_al_pool</span><span class="si">}</span><span class="s2"> provide &#39;--slurm-al-pool&#39; with a valid file&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">input_initial_template</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Initial template </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">input_initial_template</span><span class="si">}</span><span class="s2"> provide &#39;--initial-template&#39; with a valid file&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">input_retrain_template</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Retraining template </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">input_retrain_template</span><span class="si">}</span><span class="s2"> provide &#39;--retrain-template&#39; with a valid file&quot;</span>
    <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">quorum</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Quorum should be &gt;=25, got </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">quorum</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="prepare_dispatcher"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.prepare_dispatcher">[docs]</a><span class="k">def</span> <span class="nf">prepare_dispatcher</span><span class="p">(</span><span class="n">global_cfg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">log_conf</span><span class="p">):</span>
    <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">ModelDispatcher</span><span class="p">(</span>
        <span class="n">cfg</span><span class="o">=</span><span class="n">global_cfg</span><span class="p">,</span>
        <span class="n">quorum</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">quorum</span><span class="p">,</span>
        <span class="n">slurm_job_prefix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_job_prefix</span><span class="p">,</span>
        <span class="n">last_timepoint</span><span class="o">=</span><span class="n">global_cfg</span><span class="o">.</span><span class="n">last_timepoint</span><span class="p">,</span>
        <span class="n">initial_template</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input_initial_template</span><span class="p">,</span>
        <span class="n">retrain_template</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input_retrain_template</span><span class="p">,</span>
        <span class="n">slurm_template</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input_slurm_template</span><span class="p">,</span>
        <span class="n">slurm_req_mem</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_req_mem</span><span class="p">,</span>
        <span class="n">slurm_req_partition</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_req_partition</span><span class="p">,</span>
        <span class="n">slurm_req_cores</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_req_cores</span><span class="p">,</span>
        <span class="n">slurm_al_pool</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_al_pool</span><span class="p">,</span>
        <span class="n">slurm_al_smiles</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_al_smiles_csv_column</span><span class="p">,</span>
        <span class="n">save_previous_models</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">save_previous_models</span><span class="p">,</span>
        <span class="n">log_conf</span><span class="o">=</span><span class="n">log_conf</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">dispatcher</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../optunaz.html#optunaz.automl.main">[docs]</a><span class="nd">@pidfile</span><span class="p">(</span><span class="n">piddir</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;AutoML scheduling for temporal automatic retraining of QSARtuna models&quot;</span>
    <span class="p">)</span>

    <span class="c1"># fmt: off</span>
    <span class="n">requiredNamed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;required named arguments&#39;</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output-path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the output AutoML directory&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--email&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Email for SLURM job notifications&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--user_name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;HPC &#39;username&#39; for the AutoML user&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Input file variables</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--input-data&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the input file[s]. For multiple files use &#39;*&#39; in wildcard expression&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--input-smiles-csv-column&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Column name of SMILES column in csv file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--input-activity-csv-column&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Column name of activity column in data file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--input-task-csv-column&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Column name of task column in data file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--input-initial-template&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--input-retrain-template&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--input-slurm-template&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Non-required AutoML variables</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--quorum&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--n-cores&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># No. cores for this pipeline, not SLURM</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dry-run&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># SLURM global variables</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-req-cores&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-req-mem&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># By default, None = dynamic mem resource allocation</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-req-partition&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-al-pool&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-al-smiles-csv-column&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># dispatcher variables</span>
    <span class="n">requiredNamed</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-job-prefix&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-failure-cores-increment&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-failure-mem-increment&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-failure-mins-increment&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">720</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-failure-max-retries&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-failure-max-mem&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--slurm-failure-max-cpu&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save-previous-models&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="c1"># fmt: on</span>

    <span class="n">args</span><span class="p">,</span> <span class="n">leftovers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
    <span class="n">log_conf</span> <span class="o">=</span> <span class="n">LOG_CONFIG</span>
    <span class="k">match</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
    <span class="n">log_conf</span><span class="p">[</span><span class="s2">&quot;handlers&quot;</span><span class="p">][</span><span class="s2">&quot;stdout_handler&quot;</span><span class="p">][</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdout</span>
    <span class="n">log_conf</span><span class="p">[</span><span class="s2">&quot;handlers&quot;</span><span class="p">][</span><span class="s2">&quot;stderr_handler&quot;</span><span class="p">][</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stderr</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">log_conf</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">validate_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">global_cfg</span> <span class="o">=</span> <span class="n">ModelAutoML</span><span class="p">(</span>
        <span class="n">output_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span>
        <span class="n">input_data</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">user_name</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span>
        <span class="n">n_cores</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">n_cores</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span>
        <span class="n">smiles_col</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input_smiles_csv_column</span><span class="p">,</span>
        <span class="n">activity_col</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input_activity_csv_column</span><span class="p">,</span>
        <span class="n">task_col</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">input_task_csv_column</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">global_cfg</span><span class="o">.</span><span class="n">setRetrainingData</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">NoNewRetrainingData</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;NoNewRetrainingData, so exiting&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">RetrainingHeadersIssue</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Work not possible for timepoint </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> due missing header[s] </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">global_cfg</span><span class="o">.</span><span class="n">setProcessedTimepoints</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing timepoint </span><span class="si">{</span><span class="n">global_cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">prepare_dispatcher</span><span class="p">(</span><span class="n">global_cfg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">log_conf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">global_cfg</span><span class="o">.</span><span class="n">first_run</span><span class="p">:</span>
            <span class="n">global_cfg</span><span class="o">.</span><span class="n">initProcessedTimepoints</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dispatcher_process</span><span class="p">(</span><span class="n">global_cfg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">dispatcher</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;Working&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exiting at this timepoint since there is work to do&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Work: </span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">Working</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AutoML script took [</span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.08</span><span class="si">}</span><span class="s2">] seconds.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s2">&quot;Locked&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">prepare_dispatcher</span><span class="p">(</span><span class="n">global_cfg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">log_conf</span><span class="p">)</span>
            <span class="n">dispatcher</span><span class="o">.</span><span class="n">resubmitAnyFailedJobs</span><span class="p">(</span>
                <span class="n">results</span><span class="o">.</span><span class="n">Locked</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="n">mem</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_failure_mem_increment</span><span class="p">,</span>
                <span class="n">minutes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_failure_mins_increment</span><span class="p">,</span>
                <span class="n">cpu</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_failure_cores_increment</span><span class="p">,</span>
                <span class="n">max_retries</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_failure_max_retries</span><span class="p">,</span>
                <span class="n">max_mem</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_failure_max_mem</span><span class="p">,</span>
                <span class="n">max_cpu</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">slurm_failure_max_cpu</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Exiting: </span><span class="si">{</span><span class="n">global_cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2"> lock(s) indicate(s) work ongoing&quot;</span>
            <span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AutoML script took [</span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.08</span><span class="si">}</span><span class="s2">] seconds.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Work appears complete for timepoint </span><span class="si">{</span><span class="n">global_cfg</span><span class="o">.</span><span class="n">retrain_timepoint</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">global_cfg</span><span class="o">.</span><span class="n">setProcessedTimepoints</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, AstraZeneca.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>